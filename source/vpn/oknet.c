#include <sys/types.h>
#include <sys/stat.h>
#include "str.h"
#include "ip4.h"
#include "error.h"
#include "oknet.h"
#include "uint32.h"
#include "stralloc.h"

const unsigned char masks[33][4] = {
    { 0x00, 0x00, 0x00, 0x00 },
    { 0x80, 0x00, 0x00, 0x00 },
    { 0xc0, 0x00, 0x00, 0x00 },
    { 0xe0, 0x00, 0x00, 0x00 },
    { 0xf0, 0x00, 0x00, 0x00 },
    { 0xf8, 0x00, 0x00, 0x00 },
    { 0xfc, 0x00, 0x00, 0x00 },
    { 0xfe, 0x00, 0x00, 0x00 },

    { 0xff, 0x00, 0x00, 0x00 },
    { 0xff, 0x80, 0x00, 0x00 },
    { 0xff, 0xc0, 0x00, 0x00 },
    { 0xff, 0xe0, 0x00, 0x00 },
    { 0xff, 0xf0, 0x00, 0x00 },
    { 0xff, 0xf8, 0x00, 0x00 },
    { 0xff, 0xfc, 0x00, 0x00 },
    { 0xff, 0xfe, 0x00, 0x00 },

    { 0xff, 0xff, 0x00, 0x00 },
    { 0xff, 0xff, 0x80, 0x00 },
    { 0xff, 0xff, 0xc0, 0x00 },
    { 0xff, 0xff, 0xe0, 0x00 },
    { 0xff, 0xff, 0xf0, 0x00 },
    { 0xff, 0xff, 0xf8, 0x00 },
    { 0xff, 0xff, 0xfc, 0x00 },
    { 0xff, 0xff, 0xfe, 0x00 },

    { 0xff, 0xff, 0xff, 0x00 },
    { 0xff, 0xff, 0xff, 0x80 },
    { 0xff, 0xff, 0xff, 0xc0 },
    { 0xff, 0xff, 0xff, 0xe0 },
    { 0xff, 0xff, 0xff, 0xf0 },
    { 0xff, 0xff, 0xff, 0xf8 },
    { 0xff, 0xff, 0xff, 0xfc },
    { 0xff, 0xff, 0xff, 0xfe },

    { 0xff, 0xff, 0xff, 0xff }
};

static char ipstr[IP4_FMT];
static stralloc fn = {0};

int oknet(const char *dir, char ip[4], char mask[4])
{
  struct stat st;
  int i,j, cidr = 0;
  uint32 ipnum;
  char key[4];

  if (stat(dir,&st) == -1) if (errno == error_noent) return 1;

  for(i = 0; i < 33; ++i) {
    if (masks[i][0] == mask[0])
      if (masks[i][1] == mask[1])
        if (masks[i][2] == mask[2])
          if (masks[i][3] == mask[3]) {
            cidr = i;
            goto OK;
          }
  }

  return 0;

OK:
  uint32_unpack_big(ip,&ipnum);
  for (i = 32 - cidr;i <= 32;++i) {
    j = 32 - i;
    ipnum >>= i;
    ipnum <<= i;
    if (j == 0) ipnum = 0;
    uint32_pack_big(key,ipnum);
    if (!stralloc_copys(&fn, dir)) return 0;
    if (!stralloc_cats(&fn, "/")) return 0;
    if (!stralloc_catb(&fn, ipstr, ip4_fmt(ipstr, key))) return 0;
    if (!stralloc_cats(&fn, ".")) return 0;
    if (!stralloc_catint(&fn, j)) return 0;
    if (!stralloc_0(&fn)) return 0;
    if (stat(fn.s,&st) == 0) return 1;
  }
  return 0;
}
